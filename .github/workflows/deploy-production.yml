name: Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.claude/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: 'false'

env:
  REGISTRY: ghcr.io

jobs:
  # ============================================================
  # Job 1: Run Tests (Optional)
  # ============================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Skip tests (placeholder)
        run: echo "Tests skipped for deployment workflow"

  # ============================================================
  # Job 2: Build and Push Docker Images
  # ============================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service: [backend, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set lowercase repository owner
        id: lowercase
        run: echo "repo_owner=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Debug - Check tsconfig.json
        run: |
          echo "Checking tsconfig.json for ${{ matrix.service }}"
          if [ -f "./${{ matrix.service }}/tsconfig.json" ]; then
            echo "tsconfig.json exists"
            cat "./${{ matrix.service }}/tsconfig.json" | grep -A 3 "baseUrl"
          else
            echo "tsconfig.json NOT FOUND"
          fi
          echo "Files in ${{ matrix.service }}:"
          ls -la "./${{ matrix.service }}/" | head -20

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.lowercase.outputs.repo_owner }}/onquota-${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile.production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: true
          # Temporarily disabled cache to force rebuild with tsconfig.json fix
          # cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ steps.lowercase.outputs.repo_owner }}/onquota-${{ matrix.service }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ steps.lowercase.outputs.repo_owner }}/onquota-${{ matrix.service }}:buildcache,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
            NEXT_PUBLIC_API_URL=https://api.onquota.app

  # ============================================================
  # Job 3: Deploy to VPS
  # ============================================================
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    needs: build
    if: success()

    environment:
      name: production
      url: https://onquota.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory on VPS
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} "mkdir -p /opt/onquota"

      - name: Copy deployment files to VPS
        run: |
          rsync -avz -e "ssh -i ~/.ssh/deploy_key" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='.env' \
            --exclude='.env.production' \
            docker-compose.production.yml \
            .env.production.example \
            deployment/ \
            root@${{ secrets.VPS_HOST }}:/opt/onquota/

          # Copy Caddy config to shared Caddy directory
          rsync -avz -e "ssh -i ~/.ssh/deploy_key" \
            caddy/onquota.caddy \
            root@${{ secrets.VPS_HOST}}:/opt/caddy-proxy/caddy/

      - name: Create .env.production from secrets
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} << 'EOF'
            cd /opt/onquota

            # Create .env.production from secrets
            cat > .env.production << 'ENVEOF'
          # Auto-generated by GitHub Actions
          # Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          # Commit: ${{ github.sha }}

          # ============================================================
          # ENVIRONMENT & DEPLOYMENT
          # ============================================================
          NODE_ENV=production
          APP_ENV=production
          DEPLOYMENT_ENV=production
          LOG_LEVEL=info

          # ============================================================
          # DOMAINS
          # ============================================================
          DOMAIN=onquota.app
          API_DOMAIN=api.onquota.app
          FRONTEND_URL=https://onquota.app
          API_URL=https://api.onquota.app
          NEXT_PUBLIC_API_URL=https://api.onquota.app

          # ============================================================
          # DATABASE - PostgreSQL (Hetzner VPS)
          # ============================================================
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT=5432
          POSTGRES_DB=onquota_db
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}

          # ============================================================
          # REDIS
          # ============================================================
          REDIS_HOST=redis
          REDIS_PORT=6379
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          REDIS_URL=redis://:${{ secrets.REDIS_PASSWORD }}@redis:6379

          # ============================================================
          # AUTHENTICATION & SECURITY
          # ============================================================
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=7d
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          JWT_REFRESH_EXPIRES_IN=30d

          # NextAuth
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL=https://onquota.app

          # TOTP Encryption
          TOTP_ENCRYPTION_KEY=${{ secrets.TOTP_ENCRYPTION_KEY }}

          # Session
          SESSION_SECRET=${{ secrets.SESSION_SECRET }}

          # Data Encryption
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}

          # ============================================================
          # CORS
          # ============================================================
          CORS_ORIGINS=https://onquota.app,https://api.onquota.app
          CORS_METHODS=GET,POST,PUT,PATCH,DELETE,OPTIONS
          CORS_CREDENTIALS=true

          # ============================================================
          # CELERY & BACKGROUND TASKS
          # ============================================================
          CELERY_BROKER_URL=redis://:${{ secrets.REDIS_PASSWORD }}@redis:6379/0
          CELERY_RESULT_BACKEND=redis://:${{ secrets.REDIS_PASSWORD }}@redis:6379/0

          # ============================================================
          # MONITORING (Optional)
          # ============================================================
          FLOWER_PASSWORD=${{ secrets.FLOWER_PASSWORD }}
          GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}

          # ============================================================
          # EMAIL (If configured)
          # ============================================================
          EMAIL_ENABLED=false

          # ============================================================
          # FEATURE FLAGS
          # ============================================================
          FEATURE_MULTI_TENANT_ENABLED=true
          FEATURE_ENCRYPTION_ENABLED=true

          ENVEOF

            chmod 600 .env.production
          EOF

      - name: Set lowercase repository owner
        id: lowercase
        run: echo "repo_owner=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Pull Docker images on VPS
        run: |
          REPO_OWNER_LC="${{ steps.lowercase.outputs.repo_owner }}"
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} << EOF
            cd /opt/onquota

            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull latest images
            docker pull ghcr.io/${REPO_OWNER_LC}/onquota-backend:latest
            docker pull ghcr.io/${REPO_OWNER_LC}/onquota-frontend:latest
          EOF

      - name: Backup current deployment (if exists)
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} << 'EOF'
            if [ -d "/opt/onquota/backups" ]; then
              BACKUP_NAME="backup_$(date +%Y%m%d_%H%M%S)"
              mkdir -p /opt/onquota/backups

              # Backup docker-compose and .env
              if [ -f "/opt/onquota/docker-compose.production.yml" ]; then
                cp /opt/onquota/docker-compose.production.yml "/opt/onquota/backups/${BACKUP_NAME}_docker-compose.yml"
              fi

              if [ -f "/opt/onquota/.env.production" ]; then
                cp /opt/onquota/.env.production "/opt/onquota/backups/${BACKUP_NAME}_env"
              fi

              echo "✓ Backup created: ${BACKUP_NAME}"
            fi
          EOF

      - name: Deploy with Docker Compose
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} << 'EOF'
            cd /opt/onquota

            # Stop old containers (if any)
            docker compose -f docker-compose.production.yml down || true

            # Start new containers
            docker compose -f docker-compose.production.yml up -d

            echo "✓ Containers started"
          EOF

      - name: Wait for services to be healthy
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} << 'EOF'
            cd /opt/onquota

            echo "Waiting for services to be healthy..."
            sleep 30

            # Check health
            docker compose -f docker-compose.production.yml ps
          EOF

      - name: Run health checks
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} << 'EOF'
            # Check backend health
            BACKEND_HEALTH=$(docker exec onquota-backend wget -q -O - http://localhost:8000/api/v1/health || echo "FAIL")
            echo "Backend health: $BACKEND_HEALTH"

            # Check frontend health
            FRONTEND_HEALTH=$(docker exec onquota-frontend wget -q -O - http://localhost:3000/api/health || echo "FAIL")
            echo "Frontend health: $FRONTEND_HEALTH"

            if [[ "$BACKEND_HEALTH" == "FAIL" ]] || [[ "$FRONTEND_HEALTH" == "FAIL" ]]; then
              echo "❌ Health checks failed!"
              docker compose -f /opt/onquota/docker-compose.production.yml logs --tail=50
              exit 1
            fi

            echo "✓ All health checks passed"
          EOF

      - name: Cleanup old Docker images
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} << 'EOF'
            # Remove dangling images
            docker image prune -f

            # Keep only last 3 versions of each image
            docker images | grep "onquota-backend" | tail -n +4 | awk '{print $3}' | xargs -r docker rmi -f || true
            docker images | grep "onquota-frontend" | tail -n +4 | awk '{print $3}' | xargs -r docker rmi -f || true
          EOF

      - name: Send deployment notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          EMOJI="✅"
          if [ "$STATUS" != "success" ]; then
            EMOJI="❌"
          fi

          echo "$EMOJI Deployment $STATUS"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Deployed to: https://onquota.app"

  # ============================================================
  # Job 4: Reload Caddy Configuration
  # ============================================================
  reload-caddy:
    name: Reload Caddy
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Reload Caddy configuration
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} \
            "docker exec caddy-proxy caddy reload --config /etc/caddy/Caddyfile"

      - name: Verify Caddy reload
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} \
            "docker logs caddy-proxy --tail=20"

# ============================================================
# Workflow Summary
# ============================================================
# This workflow:
# 1. Runs tests (backend + frontend)
# 2. Builds Docker images and pushes to GHCR
# 3. Deploys to VPS using docker-compose
# 4. Updates Caddy configuration for multi-app
# 5. Runs health checks
# 6. Cleans up old images
#
# Required GitHub Secrets:
# - SSH_PRIVATE_KEY: SSH key for VPS access
# - VPS_HOST: 91.98.42.19
# - DATABASE_URL: PostgreSQL connection string
# - POSTGRES_HOST, POSTGRES_USER, POSTGRES_PASSWORD
# - REDIS_PASSWORD
# - SECRET_KEY, JWT_SECRET, JWT_REFRESH_SECRET
# - NEXTAUTH_SECRET, SESSION_SECRET
# - TOTP_ENCRYPTION_KEY, ENCRYPTION_KEY
# - FLOWER_PASSWORD, GRAFANA_ADMIN_PASSWORD (optional)
# ============================================================
