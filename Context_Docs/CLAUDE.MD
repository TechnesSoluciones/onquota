# CLAUDE.MD - Gu√≠a de Contexto para Claude AI

## üéØ Prop√≥sito del Proyecto

OnQuota es un SaaS modular dise√±ado para vendedores y equipos de ventas, enfocado en:
- **Trazabilidad** de actividades comerciales
- **Control de gastos** con OCR automatizado
- **Anal√≠tica comercial** avanzada (SPA Analysis)
- **Gesti√≥n multi-tenant** con roles diferenciados

## üèóÔ∏è Arquitectura del Proyecto

### Stack Tecnol√≥gico
- **Backend**: FastAPI (Python 3.11+)
- **Frontend**: Next.js (React)
- **Base de Datos**: PostgreSQL
- **Cache**: Redis
- **Queue**: Celery + Redis
- **OCR**: Tesseract / Vision API
- **Analytics**: Pandas + Plotly/Dash

### Arquitectura
- Microservicios ligeros con API Gateway
- Modelo multi-tenant (tenant_id en todas las tablas)
- Comunicaci√≥n REST (fase 1) ‚Üí gRPC (fase 2)

## üîê Sistema de Autenticaci√≥n

### Roles del Sistema
1. **Admin**: Acceso total, configuraci√≥n de empresa
2. **SalesRep**: Registro de ventas, gastos y visitas
3. **Supervisor**: Revisi√≥n, aprobaci√≥n y reportes
4. **Analyst**: Acceso a m√≥dulos de an√°lisis SPA y m√©tricas

### Tokens
- Access token JWT: 15 minutos
- Refresh token: 7 d√≠as
- OAuth2 con soporte SSO (fase 2)

## üì¶ M√≥dulos Principales

### 1. Gesti√≥n de Gastos (Expenses Service)
- Registro manual de gastos
- Upload de facturas con OCR
- Categorizaci√≥n autom√°tica
- Reportes por per√≠odo

### 2. Transporte
- Combustible
- Peajes
- Mantenimiento vehicular

### 3. Ventas y Cotizaciones
- Creaci√≥n de cotizaciones
- Seguimiento de estados (pendiente, ganada, perdida)
- Pipeline de ventas

### 4. SPA Analysis
- Upload de archivos Excel/CSV
- An√°lisis de descuentos y m√°rgenes
- C√°lculo de KPIs comerciales
- Visualizaciones interactivas

### 5. Account Planner
- Planes de cuenta por cliente
- Estrategias comerciales
- Seguimiento de objetivos

### 6. Cuotas y M√©tricas
- Definici√≥n de cuotas por vendedor
- Panel de cumplimiento
- Hist√≥rico de desempe√±o

### 7. Visitas y Llamadas
- Registro con geolocalizaci√≥n (GPS)
- Historial de interacciones
- Resumen de actividades

### 8. Gesti√≥n de Clientes (CRM)
- CRUD completo de clientes
- Historial de interacciones
- Datos de contacto y comerciales

### 9. Oportunidades
- Pipeline de oportunidades
- Gesti√≥n por etapas
- Probabilidad de cierre

## ü§ñ Servicio OCR/AI

### Flujo de Procesamiento
1. Upload de imagen (jpg, png, pdf)
2. Limpieza con OpenCV
3. OCR con Tesseract/Vision API
4. Normalizaci√≥n con Regex + NLP
5. Extracci√≥n de datos:
   - Proveedor
   - Monto
   - Fecha
   - Categor√≠a
   - Nivel de confianza (confidence)

### Output Esperado
```json
{
  "provider": "Texaco",
  "amount": 53.20,
  "date": "2025-10-22",
  "category": "Combustible",
  "confidence": 0.93
}
```

## üìä Sistema de Alertas

### Tipos de Alertas
- Cotizaciones vencidas (>7 d√≠as sin respuesta)
- Cuotas no cumplidas
- Mantenimiento pendiente
- Recordatorio de visitas

### Canales
- Notificaci√≥n in-app
- Push notification
- Email (SendGrid / AWS SES)

### Motor
- Celery Beat para tareas programadas
- Redis como message broker

## üìÅ Estructura del Proyecto

```
onquota/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ api/              # FastAPI endpoints
‚îÇ   ‚îú‚îÄ‚îÄ core/             # Config, middlewares, auth
‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ expenses/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sales/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ accounts/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ clients/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ opportunities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notifications/
‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ store/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ .env.example
‚îî‚îÄ‚îÄ README.md
```

## üõ°Ô∏è Seguridad

- **Encriptaci√≥n**: AES-256 para datos sensibles
- **Protocolo**: HTTPS obligatorio (TLS 1.3)
- **Auditor√≠a**: Logs con usuario, acci√≥n y timestamp
- **Backup**: Automatizado diario
- **Compliance**: GDPR / ISO 27001

## üìè Est√°ndares de C√≥digo

### Testing
- **Unit tests**: Pytest con coverage > 80%
- **Integration tests**: Postman/Newman
- **Frontend**: Jest + React Testing Library
- **Load testing**: Locust / k6
- **Static analysis**: MyPy + Ruff + ESLint

### M√©tricas de Desempe√±o (KPIs T√©cnicos)
- API response time < 300 ms
- Uptime 99.5%
- OCR accuracy > 90%
- Background job latency < 2s
- DB query time P95 < 50 ms

## üé® Principios de Desarrollo

1. **API-First**: Dise√±o de API antes de implementaci√≥n
2. **Modular**: M√≥dulos desacoplados para f√°cil migraci√≥n
3. **Documentado**: OpenAPI (Swagger UI) para toda la API
4. **Feature Flags**: Habilitaci√≥n gradual de funcionalidades
5. **As√≠ncrono**: Procesamiento de tareas pesadas en background

## üí° Cuando Trabajes en Este Proyecto

### Si est√°s desarrollando Backend:
- Usa FastAPI con async/await
- Implementa validaci√≥n con Pydantic
- Respeta el esquema multi-tenant (tenant_id)
- Documenta endpoints con docstrings
- Escribe tests unitarios

### Si est√°s desarrollando Frontend:
- Usa TypeScript
- Implementa React Hooks
- Gesti√≥n de estado con Context API o Zustand
- Responsive design (mobile-first)
- Lazy loading de componentes

### Si est√°s trabajando con OCR:
- Valida calidad de imagen antes de procesar
- Implementa retry logic
- Guarda im√°genes originales para auditor√≠a
- Usa confidence threshold (> 0.85)

### Si est√°s trabajando con Analytics:
- Procesamiento as√≠ncrono con Celery
- Cache de resultados frecuentes
- Paginaci√≥n en grandes datasets
- Exportaci√≥n a Excel/PDF

## üöÄ Comandos √ötiles

```bash
# Backend
cd backend
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
uvicorn api.main:app --reload

# Frontend
cd frontend
npm install
npm run dev

# Docker
docker-compose up -d
docker-compose logs -f

# Tests
pytest tests/ -v --cov
npm test
```

## üìû Consideraciones Importantes

- Todas las fechas en UTC
- Moneda en formato decimal (2 decimales)
- Im√°genes m√°ximo 10MB
- Rate limiting: 100 req/min por usuario
- Paginaci√≥n default: 20 items
- Soft delete para datos cr√≠ticos
- Versionado de API: /api/v1/

---

**Versi√≥n**: 1.0  
**√öltima actualizaci√≥n**: Noviembre 2025  
**Mantenedor**: Tech Lead OnQuota